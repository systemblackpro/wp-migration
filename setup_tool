#!/bin/bash

# Colores para mensajes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # Sin color

print_message() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[ADVERTENCIA]${NC} $1"
}

# Verificar si se está ejecutando como root
if [ "$EUID" -ne 0 ]; then 
    print_error "Por favor, ejecuta este script como root (usa sudo)"
    exit 1
fi

print_message "Clonando repositorio..."
if git clone https://github.com/systemblackpro/wp-migration.git; then
    print_message "✓ Repositorio clonado exitosamente"
else
    print_error "Error al clonar el repositorio"
    exit 1
fi

cd wp-migration || exit 1

# Dar permisos de ejecución al script principal
chmod +x wp-migration-backup.sh

# Variables cPanel
read -p "Ingresa nombre de usuario cPanel: " name_cpanel

if [ -z "$name_cpanel" ]; then
    print_error "El nombre de usuario no puede estar vacío"
    exit 1
fi

print_message "Usuario cPanel: $name_cpanel"

# Directorio de trabajo actual
CURRENT_PATH="$(pwd)"
print_message "Directorio actual: $CURRENT_PATH"

# Verificar si el comando 'perms' existe (típico de servidores cPanel)
if command -v perms &> /dev/null; then
    print_message "Aplicando permisos de cPanel..."
    
    # Aplicar permisos al directorio actual
    if perms "$CURRENT_PATH"; then
        print_message "✓ Permisos aplicados al directorio actual"
    else
        print_warning "Advertencia al aplicar permisos al directorio"
    fi
    
    # Aplicar permisos al usuario
    if perms "$name_cpanel"; then
        print_message "✓ Permisos aplicados al usuario $name_cpanel"
    else
        print_warning "Advertencia al aplicar permisos al usuario"
    fi
else
    print_warning "Comando 'perms' no encontrado (puede que no estés en un servidor cPanel)"
    print_message "Aplicando permisos estándar..."
    
    # Buscar el directorio home del usuario
    USER_HOME="/home/$name_cpanel"
    
    if [ -d "$USER_HOME" ]; then
        # Aplicar permisos estándar
        chown -R "$name_cpanel:$name_cpanel" "$CURRENT_PATH"
        chmod -R 755 "$CURRENT_PATH"
        print_message "✓ Permisos estándar aplicados"
    else
        print_warning "No se encontró el directorio del usuario: $USER_HOME"
    fi
fi

# Exportar la variable WP_PATH para que el script hijo la use
export WP_PATH="$CURRENT_PATH"
export NAME_CPANEL="$name_cpanel"

print_message "=== Iniciando script de migración ==="
echo ""

# Ejecutar el script de migración
./wp-migration-backup.sh
