#!/bin/bash

# Colores para mensajes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # Sin color

print_message() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[ADVERTENCIA]${NC} $1"
}

print_header() {
    echo -e "${BLUE}╔════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║     WordPress Migration Tool - Setup Automático       ║${NC}"
    echo -e "${BLUE}╚════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

# Verificar si se está ejecutando como root
check_root() {
    if [ "$EUID" -ne 0 ]; then 
        print_error "Este script debe ejecutarse como root"
        print_message "Ejecuta: curl -fsSL https://raw.githubusercontent.com/systemblackpro/wp-migration/refs/heads/main/setup_tool | sudo bash"
        exit 1
    fi
}

# Verificar dependencias
check_dependencies() {
    print_message "Verificando dependencias..."
    
    if ! command -v git &> /dev/null; then
        print_error "Git no está instalado"
        read -p "¿Deseas instalar Git ahora? (s/n): " install_git
        if [ "$install_git" == "s" ]; then
            if command -v yum &> /dev/null; then
                yum install -y git
            elif command -v apt-get &> /dev/null; then
                apt-get update && apt-get install -y git
            else
                print_error "No se pudo instalar Git automáticamente"
                exit 1
            fi
        else
            exit 1
        fi
    fi
    
    if ! command -v wp &> /dev/null; then
        print_warning "WP-CLI no está instalado"
        read -p "¿Deseas instalar WP-CLI ahora? (s/n): " install_wp
        if [ "$install_wp" == "s" ]; then
            curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
            chmod +x wp-cli.phar
            mv wp-cli.phar /usr/local/bin/wp
            print_message "✓ WP-CLI instalado correctamente"
        fi
    fi
}

# Función principal
main() {
    print_header
    check_root
    check_dependencies
    
    echo ""
    print_message "Configuración inicial..."
    echo ""
    
    # Solicitar nombre de cPanel
    while true; do
        read -r -p "$(echo -e ${BLUE})Ingresa el nombre del usuario cPanel (ej: dragon): $(echo -e ${NC})" name_cpanel
        if [ -n "$name_cpanel" ]; then
            if [ -d "/home/$name_cpanel" ]; then
                print_message "✓ Usuario cPanel: $name_cpanel"
                break
            else
                print_error "El directorio /home/$name_cpanel no existe"
                read -p "¿Deseas continuar de todas formas? (s/n): " continue_anyway
                if [ "$continue_anyway" == "s" ]; then
                    break
                fi
            fi
        else
            print_error "El nombre de usuario no puede estar vacío"
        fi
    done
    
    # Solicitar nombre de dominio
    while true; do
        read -r -p "$(echo -e ${BLUE})Ingresa el nombre del dominio (ej: midominio.com): $(echo -e ${NC})" dominio
        if [ -n "$dominio" ]; then
            print_message "✓ Dominio: $dominio"
            break
        else
            print_error "El dominio no puede estar vacío"
        fi
    done
    
    # Determinar el directorio de WordPress
    POSSIBLE_PATHS=(
        "/home/$name_cpanel/public_html"
        "/home/$name_cpanel/$dominio"
        "/home/$name_cpanel/public_html/$dominio"
        "/home/$name_cpanel/domains/$dominio/public_html"
    )
    
    WP_PATH=""
    echo ""
    print_message "Buscando instalación de WordPress..."
    
    for path in "${POSSIBLE_PATHS[@]}"; do
        if [ -f "$path/wp-config.php" ]; then
            WP_PATH="$path"
            print_message "✓ WordPress encontrado en: $WP_PATH"
            break
        fi
    done
    
    if [ -z "$WP_PATH" ]; then
        print_warning "No se encontró WordPress automáticamente"
        read -r -p "$(echo -e ${BLUE})Ingresa la ruta completa de WordPress: $(echo -e ${NC})" WP_PATH
        
        if [ ! -f "$WP_PATH/wp-config.php" ]; then
            print_error "No se encuentra wp-config.php en $WP_PATH"
            exit 1
        fi
    fi
    
    # Cambiar al directorio de WordPress
    cd "$WP_PATH" || {
        print_error "No se pudo acceder al directorio $WP_PATH"
        exit 1
    }
    
    print_message "Directorio actual: $(pwd)"
    echo ""
    
    # Clonar repositorio
    print_message "Clonando repositorio wp-migration..."
    
    # Eliminar directorio existente si existe
    if [ -d "wp-migration" ]; then
        print_warning "El directorio wp-migration ya existe, eliminando..."
        rm -rf wp-migration
    fi
    
    if git clone https://github.com/systemblackpro/wp-migration.git; then
        print_message "✓ Repositorio clonado exitosamente"
    else
        print_error "Error al clonar el repositorio"
        exit 1
    fi
    
    cd wp-migration || {
        print_error "No se pudo acceder al directorio wp-migration"
        exit 1
    }
    
    # Dar permisos de ejecución
    chmod +x *.sh 2>/dev/null
    
    # Verificar que los archivos .zip existan
    print_message "Verificando archivos de plugins..."
    
    PLUGIN_BASE="all-in-one-wp-migration.zip"
    PLUGIN_EXT="all-in-one-wp-migration-unlimited-extension.zip"
    
    if [ ! -f "$PLUGIN_BASE" ]; then
        print_warning "No se encuentra $PLUGIN_BASE en el repositorio"
        print_message "Deberás subirlo manualmente a: $(pwd)"
    fi
    
    if [ ! -f "$PLUGIN_EXT" ]; then
        print_warning "No se encuentra $PLUGIN_EXT en el repositorio"
        print_message "Deberás subirlo manualmente a: $(pwd)"
    fi
    
    # Aplicar permisos cPanel si está disponible
    if command -v perms &> /dev/null; then
        print_message "Aplicando permisos de cPanel..."
        perms "$name_cpanel" 2>/dev/null
        perms "$WP_PATH" 2>/dev/null
        print_message "✓ Permisos aplicados"
    else
        print_message "Aplicando permisos estándar..."
        chown -R "$name_cpanel:$name_cpanel" "$WP_PATH/wp-migration"
        chmod -R 755 "$WP_PATH/wp-migration"
        print_message "✓ Permisos aplicados"
    fi
    
    # Exportar variables para el script de migración
    export WP_PATH="$WP_PATH"
    export NAME_CPANEL="$name_cpanel"
    export DOMINIO="$dominio"
    
    echo ""
    print_message "╔════════════════════════════════════════════════════════╗"
    print_message "║            Configuración completada                    ║"
    print_message "╚════════════════════════════════════════════════════════╝"
    echo ""
    print_message "Usuario cPanel: $name_cpanel"
    print_message "Dominio: $dominio"
    print_message "WordPress: $WP_PATH"
    print_message "Scripts: $WP_PATH/wp-migration"
    echo ""
    
    # Preguntar si desea ejecutar el script de migración ahora
    read -p "¿Deseas ejecutar el script de migración ahora? (s/n): " run_now
    
    if [ "$run_now" == "s" ]; then
        echo ""
        print_message "═══════════════════════════════════════════════════════"
        print_message "Iniciando script de migración..."
        print_message "═══════════════════════════════════════════════════════"
        echo ""
        
        if [ -f "wp-migration-backup.sh" ]; then
            ./wp-migration-backup.sh
        else
            print_error "No se encuentra wp-migration-backup.sh"
            print_message "Ejecuta manualmente: cd $WP_PATH/wp-migration && ./wp-migration-backup.sh"
        fi
    else
        echo ""
        print_message "Para ejecutar el script de migración más tarde:"
        print_message "  cd $WP_PATH/wp-migration"
        print_message "  sudo ./wp-migration-backup.sh"
        echo ""
    fi
}

# Ejecutar función principal
main
